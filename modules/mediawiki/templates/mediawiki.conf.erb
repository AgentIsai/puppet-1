map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
}

server {
	listen 80 deferred;
	listen [::]:80 deferred ipv6only=on;

	server_name ~.;

	location ~ ^/check$ {
                proxy_pass http://127.0.0.1:81;
		proxy_http_version 1.1;
		proxy_set_header Connection close;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_buffering    off;
		proxy_read_timeout 60s;
		proxy_send_timeout 60s;
		send_timeout       60s;
	}

	# no way you are legit - rhinosf1 T8832
	if ($http_user_agent ~ "MJ12bot") {
		return 403;
	}

	location / {
                if ($request_uri !~ "^/check$") {
			return 301 https://$host$request_uri;
		}
	}
}

server {
	# We can only set backlog once per port (so this will be applied to the others below)
	listen 443 ssl http2 deferred backlog=16384;
	listen [::]:443 ssl http2 deferred  backlog=16384 ipv6only=on;

	server_name wikiforge.net *.wikiforge.net;
	root /var/www/html;

	ssl_certificate /etc/ssl/localcerts/wildcard.wikiforge.net.crt;
	ssl_certificate_key /etc/ssl/private/wildcard.wikiforge.net.key;

	ssl_stapling_verify on;
	
	# no way you are legit - rhinosf1 T8832
	if ($http_user_agent ~ "MJ12bot") {
		return 403;
	}

	location / {
		proxy_pass http://127.0.0.1:81;
		proxy_http_version 1.1;
		proxy_set_header Connection $connection_upgrade;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_read_timeout 140s;
		proxy_send_timeout 140s;
		send_timeout       140s;
		proxy_buffer_size       32k;
		proxy_buffers         4 32k;
		# Remove duplicate headers that is already added on the frontend
		proxy_hide_header     X-XSS-Protection;
		proxy_hide_header     X-Frame-Options;
		proxy_buffering    off;
	}
}

server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;
	server_name m.wikiforge.net *.m.wikiforge.net;

	root /var/www/html;

	ssl_certificate /etc/ssl/localcerts/m.wikiforge.net.crt;
	ssl_certificate_key /etc/ssl/private/m.wikiforge.net.key;

	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
	
	# no way you are legit - rhinosf1 T8832
	if ($http_user_agent ~ "MJ12bot") {
		return 403;
	}

	if ($host ~ ^(\w+)\.m\.wikiforge\.net$) {
		return 301 https://$1.wikiforge.net$request_uri;
	}

	return 301 https://wikiforge.net$request_uri;
}
